<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QR Shop Order</title>
<style>
body { font-family: system-ui; margin: 20px; }
input, button { padding: 8px; margin: 5px 0; width: 100%; }
img { max-width: 200px; display: block; margin-top: 10px; }
</style>
</head>
<body>
<h1>ðŸ›’ Scan QR & Add to Order</h1>

<div id="reader" style="width:100%"></div>
<div id="product-info"></div>
<div id="cart"></div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let products = JSON.parse(localStorage.getItem("products") || "[]");
let cart = [];

function startScanner() {
    let html5QrcodeScanner = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
        if(devices.length) {
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                qrCodeMessage => {
                    html5QrcodeScanner.stop();
                    showProduct(qrCodeMessage);
                }
            );
        }
    });
}

function showProduct(code) {
    let id = code.replace("product:", "").trim();
    let product = products.find(p => p.id == id);
    if(!product) {
        alert("Product not found!");
        return;
    }
    document.getElementById("product-info").innerHTML = `
        <h3>${product.dno}</h3>
        <p>Price: â‚¹${product.price}</p>
        <p>${product.details}</p>
        <img src="${product.photo}">
        <label>Quantity</label>
        <input id="qty" type="number" value="1">
        <button onclick="addToCart(${product.id})">Add to Cart</button>
    `;
}

function addToCart(id) {
    let qty = parseInt(document.getElementById("qty").value);
    let product = products.find(p => p.id == id);
    cart.push({...product, qty});
    updateCart();
    startScanner(); // scan next item
}

function updateCart() {
    let html = "<h2>Cart</h2>";
    cart.forEach(item => {
        html += `<p>${item.dno} - ${item.qty} pcs - â‚¹${item.price * item.qty}</p>`;
    });
    html += `<button onclick="completeOrder()">Complete Order</button>`;
    document.getElementById("cart").innerHTML = html;
}

function completeOrder() {
    alert("Order completed! Items: " + cart.length);
    cart = [];
    updateCart();
}
function saveOrderToSheet(order) {
  fetch("https://script.google.com/macros/s/AKfycbzI-bQSA0jPMJN2ndeSpFsmVhJ5Z3O4oP8GTT4E_e0Bpc4cO5VZun33oZbll9PzplPrcQ/exec", {
    method: "POST",
    body: JSON.stringify(order)
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      alert("Order saved to Google Sheet!");
    }
  })
  .catch(err => console.error(err));
}

startScanner();
</script>
</body>
</html>
