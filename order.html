<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>QR Shop — Order</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{font-family:system-ui;padding:12px}
button,input{padding:10px;margin:6px 0;width:100%}
img.thumb{max-width:120px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid #ddd;padding:8px}
</style>
</head>
<body>
<h2>Order — Scan & Add</h2>
<button id="startScan">Start Scan</button>
<button id="stopScan">Stop</button>
<div id="reader" style="width:100%;max-width:420px"></div>

<div id="productArea" style="display:none">
  <img id="prodPhoto" class="thumb"><div id="prodName"></div>
  <div>ID: <span id="prodNo"></span></div>
  <div>Price: ₹<span id="prodPrice"></span></div>
  <input id="prodQty" type="number" min="1" value="1">
  <button id="addToCart">Add to Cart</button>
</div>

<h3>Cart</h3>
<table class="table" id="cartTable"><thead><tr><th>Photo</th><th>Name</th><th>Qty</th><th>Price</th><th>Total</th><th>Action</th></tr></thead><tbody></tbody></table>
<div>Total: ₹<span id="grandTotal">0</span></div>

<h3>Customer</h3>
<input id="customerName" placeholder="Customer Name">
<input id="customerPhone" placeholder="Customer Mobile">

<button id="completeOrder">Complete Order (Save & PDF)</button>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrtxqwfAwxvmuR9z40cWcJRPNeTD-wZSFiIXIa5-LB2FEZLpQna_PQh1zojlOoKdzg9A/exec"; 
let scanner = null;
let currentProduct = null;
let cart = [];

// Start/Stop scanner
document.getElementById('startScan').addEventListener('click', async ()=>{
  if(scanner) return;
  const html5QrCode = new Html5Qrcode("reader");
  const config = { fps: 10, qrbox: 250 };
  try {
    const devices = await Html5Qrcode.getCameras();
    const cameraId = devices.length ? devices[0].id : null;
    await html5QrCode.start({ deviceId: { exact: cameraId } }, config, (decoded)=> {
      html5QrCode.pause(); 
      onScanned(decoded);
    }, (err)=>{ /* ignore */ });
    scanner = html5QrCode;
  } catch(err){ alert('Camera error: ' + err); }
});
document.getElementById('stopScan').addEventListener('click', ()=>{ if(scanner){ scanner.stop(); scanner.clear(); scanner=null; }});

// When QR scanned
async function onScanned(productNo){
  try {
    const res = await fetch(SCRIPT_URL + '?action=getProduct&productNo=' + encodeURIComponent(productNo));
    const j = await res.json();
    if(j.status === 'ok' && j.product){
      currentProduct = j.product;
      document.getElementById('prodPhoto').src = currentProduct.photo || '';
      document.getElementById('prodName').textContent = currentProduct.productName || '';
      document.getElementById('prodNo').textContent = currentProduct.productNo || '';
      document.getElementById('prodPrice').textContent = currentProduct.price || 0;
      document.getElementById('productArea').style.display = 'block';
    } else {
      alert('Product not found');
      if(scanner){ scanner.resume(); }
    }
  } catch(err){
    alert('Fetch error: '+err);
    if(scanner){ scanner.resume(); }
  }
}

// Add to cart
document.getElementById('addToCart').addEventListener('click', ()=>{
  const qty = Number(document.getElementById('prodQty').value||1);
  if(!currentProduct) return alert('No product loaded');
  const item = {
    productNo: currentProduct.productNo,
    productName: currentProduct.productName,
    price: Number(currentProduct.price||0),
    photo: currentProduct.photo||'',
    qty, total: qty * Number(currentProduct.price||0)
  };
  cart.push(item);
  currentProduct = null;
  document.getElementById('productArea').style.display = 'none';
  renderCart();
  if(scanner){ scanner.resume(); }
});

// render cart
function renderCart(){
  const tbody = document.querySelector('#cartTable tbody'); tbody.innerHTML='';
  let grand = 0;
  cart.forEach((it, idx)=>{
    grand += it.total;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><img src="${it.photo}" class="thumb"></td><td>${it.productName}</td>
      <td><input type="number" value="${it.qty}" data-idx="${idx}" class="qtyInp" style="width:60px"></td>
      <td>₹${it.price}</td><td>₹${it.total.toFixed(2)}</td><td><button data-del="${idx}">Remove</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('grandTotal').textContent = grand.toFixed(2);

  document.querySelectorAll('.qtyInp').forEach(inp=> inp.addEventListener('change', (e)=>{
    const i = Number(e.target.dataset.idx); const v = Number(e.target.value||1);
    cart[i].qty = v; cart[i].total = cart[i].price * v; renderCart();
  }));
  document.querySelectorAll('button[data-del]').forEach(b=> b.addEventListener('click', (e)=>{
    const i = Number(e.target.dataset.del); cart.splice(i,1); renderCart();
  }));
}

// Complete order
document.getElementById('completeOrder').addEventListener('click', async ()=>{
  const name = document.getElementById('customerName').value.trim();
  const phone = document.getElementById('customerPhone').value.trim();
  if(!name || !phone) return alert('Enter customer details');
  if(!cart.length) return alert('Cart empty');

  const payload = { action:'saveOrder', customerName:name, customerPhone:phone, items:cart, grandTotal: Number(document.getElementById('grandTotal').textContent||0) };
  try {
    const res = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const j = await res.json();
    if(j.status === 'success'){
      alert('Order saved');
      await generatePDF({ customerName:name, customerPhone:phone, items:cart, grandTotal:payload.grandTotal });
      cart = []; renderCart(); document.getElementById('customerName').value=''; document.getElementById('customerPhone').value='';
    } else {
      alert('Save failed: ' + JSON.stringify(j));
    }
  } catch(err){ alert('Save error: ' + err); }
});

// PDF generation
async function generatePDF(order){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 20;
  doc.setFontSize(14); doc.text('Invoice / Order', 14, y); y+=10;
  doc.setFontSize(11); doc.text(`Customer: ${order.customerName}`, 14, y); y+=8;
  doc.text(`Phone: ${order.customerPhone}`, 14, y); y+=12;
  order.items.forEach((it, i)=>{
    doc.text(`${i+1}. ${it.productName} (${it.productNo})`, 14, y); y+=8;
    doc.text(`Qty: ${it.qty}  Rate: ₹${it.price}  Total: ₹${it.total.toFixed(2)}`, 18, y); y+=10;
    if(y > 270){ doc.addPage(); y = 20; }
  });
  doc.text(`Grand Total: ₹${order.grandTotal}`, 14, y+8);
  doc.save(`order_${Date.now()}.pdf`);
}
</script>
</body>
</html>
