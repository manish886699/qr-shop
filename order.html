<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Order System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  button { padding: 10px; margin: 5px 0; }
  img { max-width: 100px; margin: 5px 0; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
</style>
</head>
<body>

<h2>QR Code Order System</h2>

<button onclick="startScan()">ðŸ“· Scan QR</button>
<div id="reader" style="width:300px; margin-top:10px;"></div>

<div id="product-details" style="display:none;">
  <h3>Product Details</h3>
  <img id="product-photo">
  <p><b>ID:</b> <span id="p-id"></span></p>
  <p><b>Name:</b> <span id="p-name"></span></p>
  <p><b>Price:</b> â‚¹<span id="p-price"></span></p>
  <input type="number" id="p-qty" placeholder="Quantity" min="1">
  <button onclick="addToOrder()">Add to Order</button>
</div>

<h3>Order List</h3>
<table id="order-table">
  <thead>
    <tr><th>Photo</th><th>Name</th><th>Qty</th><th>Price</th><th>Total</th></tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Customer Details</h3>
<input type="text" id="customer-name" placeholder="Customer Name"><br>
<input type="tel" id="customer-phone" placeholder="Mobile Number"><br><br>

<button onclick="completeOrder()">âœ… Complete Order</button>

<script>
let orderItems = [];
let currentProduct = null;
const scriptURL = "https://script.google.com/macros/s/AKfycbzI-bQSA0jPMJN2ndeSpFsmVhJ5Z3O4oP8GTT4E_e0Bpc4cO5VZun33oZbll9PzplPrcQ/exec";

function startScan() {
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      html5QrCode.stop();
      fetchProduct(decodedText.trim());
    }
  ).catch(err => alert("Camera start error: " + err));
}

function fetchProduct(productNo) {
  fetch(`${scriptURL}?action=getProduct&productNo=${encodeURIComponent(productNo)}`)
    .then(res => res.json())
    .then(data => {
      if (data && data.productName) {
        currentProduct = data;
        document.getElementById("p-id").innerText = data.productNo;
        document.getElementById("p-name").innerText = data.productName;
        document.getElementById("p-price").innerText = data.price;
        document.getElementById("product-photo").src = data.photo;
        document.getElementById("product-details").style.display = "block";
      } else {
        alert("Product not found!");
      }
    })
    .catch(err => alert("Fetch error: " + err));
}

function addToOrder() {
  const qty = parseInt(document.getElementById("p-qty").value);
  if (!qty || qty < 1) return alert("Enter valid quantity");
  
  let item = {
    photo: currentProduct.photo,
    name: currentProduct.productName,
    qty: qty,
    price: currentProduct.price,
    total: qty * currentProduct.price
  };
  orderItems.push(item);
  renderTable();
  document.getElementById("product-details").style.display = "none";
}

function renderTable() {
  const tbody = document.querySelector("#order-table tbody");
  tbody.innerHTML = "";
  orderItems.forEach(item => {
    tbody.innerHTML += `<tr>
      <td><img src="${item.photo}"></td>
      <td>${item.name}</td>
      <td>${item.qty}</td>
      <td>â‚¹${item.price}</td>
      <td>â‚¹${item.total}</td>
    </tr>`;
  });
}

function completeOrder() {
  const name = document.getElementById("customer-name").value.trim();
  const phone = document.getElementById("customer-phone").value.trim();
  if (!name || !phone) return alert("Enter customer details");

  const orderData = {
    customerName: name,
    customerPhone: phone,
    items: orderItems
  };

  // Save to Google Sheet
  fetch(scriptURL, {
    method: "POST",
    body: JSON.stringify(orderData)
  })
  .then(res => res.text())
  .then(txt => {
    alert("Order saved!");
    generatePDF(orderData);
    orderItems = [];
    renderTable();
  })
  .catch(err => alert("Save error: " + err));
}

function generatePDF(order) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(`Customer: ${order.customerName}`, 10, 10);
  doc.text(`Phone: ${order.customerPhone}`, 10, 20);
  let y = 30;
  order.items.forEach(item => {
    doc.text(`${item.name} - Qty: ${item.qty} - â‚¹${item.price} - Total: â‚¹${item.total}`, 10, y);
    y += 10;
  });
  doc.save("order.pdf");
}
</script>

</body>
</html>
